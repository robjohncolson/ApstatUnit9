<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- TODO: *** MODIFY: Update Title for the specific unit *** -->
    <title>AP Statistics Unit X: [Unit Title Placeholder]</title>

    <!-- AP Statistics Data (Keep this - Loads data for ALL units for progress calculations) -->
    <script src="js/allUnitsData.js"></script>    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Mermaid JS -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    
    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- QR Code Generator Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    
    <style>
        /* Styles remain the same */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #f0f9ff;
            border-bottom: 2px solid #3b82f6;
            font-weight: bold;
        }
        
        body.quota-met-today::before {
          content: "";
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(220, 255, 220, 1); 
          z-index: -1; 
          pointer-events: none; 
          transition: background-color 0.5s ease; 
        }
        
        @media (prefers-color-scheme: dark) {
            /* No dark mode for printable worksheets */
        }
        
        .bookmark-toggle-btn.bookmarked-active svg { color: #f59e0b; }
        .bookmark-toggle-btn:hover svg { color: #3b82f6; }
        .bookmark-toggle-btn.bookmarked-active:hover svg { color: #dc2626; }
        .bookmark-toggle-btn, #global-bookmark-indicator button, #global-bookmark-indicator a { user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">

    <!-- START Bookmark Indicator Placeholder -->
    <div id="global-bookmark-indicator" class="fixed top-2 right-2 z-50 max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg xl:max-w-xl print:hidden" style="display: none;">
        <!-- Content injected by displayGlobalBookmarkIndicator() JavaScript function -->
    </div>
    <!-- END Bookmark Indicator Placeholder -->

        <header class="text-center mb-8">
            <!-- TODO: *** MODIFY: Update Header for the specific unit *** -->
            <h1 class="text-3xl font-bold text-blue-600">AP Statistics Unit X: [Unit Title Placeholder]</h1>
            
            <p class="text-gray-600 mt-2">Tools and guides to help you succeed in AP Statistics</p>
            
            <!-- TODO: *** MODIFY: Update Exam Weight for the specific unit *** -->
            <div class="mt-2 bg-yellow-100 text-yellow-800 px-4 py-2 rounded-md inline-block">
                <span class="font-semibold">Exam Weight:</span> Unit X represents [X-Y]% of the AP Statistics Exam
            </div>
        </header>
        
        <!-- Tab Navigation (Remains the same) -->
        <div class="flex mb-0 border-b border-gray-200">
            <div id="tab-learning-flow" class="tab-button active">Learning Flow</div>
            <div id="tab-flowchart" class="tab-button">Flowchart</div>
            <div id="tab-grok-prompt" class="tab-button">Grok Prompt</div>
            <div id="tab-study-materials" class="tab-button">Study Materials</div>
            <div id="tab-overall-progress" class="tab-button">Overall Progress</div>
        </div>
        
        <!-- Tab Content (Structure remains the same) -->
        <div class="bg-white rounded-b-lg shadow-md p-6">
            <!-- Learning Flow Tab -->
            <div id="content-learning-flow" class="tab-content active">
                <div id="learning-flow-app"></div> <!-- React component injects here -->
            </div>
            
            <!-- Flowchart Tab -->
            <div id="content-flowchart" class="tab-content">
                <h2 class="text-xl font-bold mb-4">AP Statistics Learning Session Flowchart</h2>
                <p class="mb-4 text-gray-600">This flowchart shows the recommended learning process using your AP Statistics resources.</p>
                <div class="bg-gray-50 p-4 rounded-lg overflow-auto max-h-[80vh]">
                    <div class="mermaid" id="flowchart"></div> <!-- Mermaid flowchart injects here -->
                </div>
                <div class="mt-4 grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
                    <div class="p-2 rounded bg-blue-100 text-blue-800">Blue: Setup</div>
                    <div class="p-2 rounded bg-yellow-100 text-yellow-800">Yellow: Video Learning</div>
                    <div class="p-2 rounded bg-green-100 text-green-800">Green: Practice</div>
                    <div class="p-2 rounded bg-purple-100 text-purple-800">Purple: Progress</div>
                    <div class="p-2 rounded bg-red-100 text-red-800">Red: Capstone</div>
                </div>
            </div>
            
            <!-- Grok Prompt Tab -->
            <div id="content-grok-prompt" class="tab-content p-6">
                <h2 class="text-2xl font-bold mb-4 text-center text-indigo-900">Start Your Grok Session</h2>
                <div class="text-xs text-gray-600 mb-4">
                    <span class="bg-green-100 text-green-800 px-1 rounded mr-1">(+)</span> 
                    Videos marked with this symbol have a Google Drive backup available if AP Classroom is down. Hover over the icon for details.
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Left Column: Prompt and Instructions -->
                    <div class="bg-white rounded-lg shadow-md p-5">
                        <h3 class="text-xl font-semibold mb-3 text-blue-800">1. Get the Prompt</h3>
                        <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
                            <pre id="grok-prompt" class="whitespace-pre-wrap text-sm"></pre> <!-- Grok prompt injects here -->
                            <div class="flex mt-4 gap-3">
                                <button id="copy-button" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                    Copy Prompt
                                </button>
                                <a href="https://grok.com" target="_blank" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"></path><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"></path></svg>
                                    Open Grok
                                </a>
                            </div>
                        </div>
                        
                        <h3 class="text-xl font-semibold mb-3 text-yellow-800">2. Video Learning Guide</h3>
                        <ol class="space-y-3 list-decimal pl-6">
                            <li class="text-gray-700"><span class="font-medium text-gray-900">Copy the prompt</span> using the button above</li>
                            <li class="text-gray-700"><span class="font-medium text-gray-900">Open Grok</span> by clicking the button or visiting <a href="https://grok.com" target="_blank" class="text-blue-600 hover:underline">grok.com</a></li>
                            <li class="text-gray-700"><span class="font-medium text-gray-900">Start a new conversation</span> and paste the prompt</li>
                            <li class="text-gray-700"><span class="font-medium text-gray-900">Download the PDFs</span> for your current topic (shown on the right)</li>
                            <li class="text-gray-700"><span class="font-medium text-gray-900">Attach both PDFs</span> to your Grok conversation using the paperclip icon</li>
                            <li class="text-gray-700"><span class="font-medium text-gray-900">Send your message</span> and start learning with Grok!</li>
                        </ol>
                        
                        <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <h4 class="font-semibold text-yellow-800 mb-2 flex items-center"><svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg> Need Help?</h4>
                            <p class="text-yellow-700 text-sm"> Watch our <a href="https://youtu.be/KPovHIIHfEo" target="_blank" class="text-blue-600 hover:underline">video tutorial</a> on using Grok with PDF attachments.</p>
                        </div>
                    </div>
                    
                    <!-- Right Column: Current Topic & Materials -->
                    <div>
                        <!-- Current Topic Box -->
                        <div class="bg-white rounded-lg shadow-md p-5 mb-6">
                            <h3 class="text-xl font-semibold mb-3 text-green-800" id="current-topic-header">3. Practice with Current Topic</h3>
                            <div id="current-topic-info" class="mb-4">
                                <p class="text-gray-500">Loading current topic information...</p> <!-- Populated by JavaScript -->
                            </div>
                            <button id="complete-current-topic-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded-md flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                Mark Current Topic as Completed
                            </button>
                        </div>
                        
                        <!-- All Topics Quick Access -->
                        <div class="bg-white rounded-lg shadow-md p-5">
                            <h3 class="text-xl font-semibold mb-3 text-purple-800 grok-prompt-topics-header">4. Track Your Progress</h3>
                            <div id="quick-access-topics" class="grid grid-cols-2 gap-3">
                                <p class="text-gray-500 col-span-2">Loading topics...</p> <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Study Materials Tab -->
            <div id="content-study-materials" class="tab-content">
                 <!-- TODO: *** MODIFY: Ensure h2 and p tags refer to the correct unit if needed, or keep generic *** -->
                <h2 class="text-2xl font-bold mb-4 text-center text-indigo-900">AP Statistics Study Materials</h2>
                <p class="text-center mb-4">Select a topic to study. Download both PDFs and attach them to your Grok conversation.</p>
                
                <div class="text-xs text-gray-600 mb-4 text-center">
                  <span class="bg-green-100 text-green-800 px-1 rounded mr-1">(+)</span> 
                  Videos marked with this symbol have a Google Drive backup available if AP Classroom is down. Hover over the icon for details.
                </div>

                <!-- All Topics Completed Message -->
                <div id="all-completed-container" class="hidden mb-6 p-6 bg-green-50 border border-green-200 rounded-lg text-center">
                    <h3 class="text-xl font-bold text-green-700 mb-2">🎉 Congratulations! 🎉</h3>
                     <!-- TODO: *** MODIFY: Ensure this message is appropriate or adjust for the specific unit *** -->
                    <p class="text-green-700 mb-4">You've completed all Unit topics including the capstone Progress Check!</p>
                    <button id="reset-progress-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        Reset Progress
                    </button>
                </div>

                <!-- Grok Prompt CTA Banner -->
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between">
                    <div>
                        <h3 class="font-bold text-blue-800 mb-1">Try our improved Grok Prompt tab!</h3>
                        <p class="text-blue-700 text-sm">We've updated the Grok Prompt tab with all these features in one place for a more streamlined experience.</p>
                    </div>
                    <button onclick="document.getElementById('tab-grok-prompt').click()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 whitespace-nowrap">
                        Go to Grok Prompt
                    </button>
                </div>
                
                <div class="mb-4">
                    <div class="flex items-center mb-2">
                        <label for="topic-select" class="mr-2 font-medium text-purple-800">Track your progress:</label>
                        <select id="topic-select" class="p-2 border rounded-md">
                            <option value="">Select a topic...</option> <!-- Populated by JavaScript -->
                        </select>
                    </div>
                    <div id="progress-container" class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                        <div id="progress-bar" class="bg-purple-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                
                <div id="topic-cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Topic cards will be dynamically inserted here -->
                </div>
                
                <div id="next-topic-container" class="mt-6 p-4 bg-purple-50 border border-purple-200 rounded-lg hidden">
                    <h3 class="font-bold text-lg mb-2 text-purple-800">Ready for the next topic?</h3>
                    <p class="mb-2 text-purple-700">Great job completing the current topic! Here's what to study next:</p>
                    <div id="next-topic-card" class="p-4 bg-white rounded-lg shadow-md"></div> <!-- Next topic card injects here -->
                </div>
            </div>
            
            <!-- Overall Progress Tab -->
            <div id="content-overall-progress" class="tab-content p-6">
                <div id="overall-progress-loading" class="text-center text-gray-500">Loading overall progress...</div>
                <div id="dot-plot-container" class="mb-6"></div> <!-- Populated by JavaScript -->
                <div id="remaining-items" class="mb-4 text-sm text-gray-700"></div> <!-- Populated by JavaScript -->
                <div id="flexible-quota" class="mb-4 text-sm text-gray-700"></div> <!-- Populated by JavaScript -->
                <div id="todays-quota-status" class="mb-6 text-sm text-gray-700"></div> <!-- Populated by JavaScript -->
                <div id="peer-quota-table-container" class="mt-6">
                    <h3 class="text-lg font-semibold mb-2 text-indigo-800">Peer Quota Progress</h3>
                    <div id="peer-quota-loading" class="text-gray-500">Loading peer data...</div>
                    <div id="peer-quota-table"></div> <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script>
        // Utility function for a simple delay (debounce)
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };
        // Utility function for sleep
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Function to update visual indicator for quota met
        async function updateQuotaMetVisualIndicator() {
            // ... (Keep this function exactly as it is in the working version) ...
             console.log('GH_DEBUG (VisualIndicator): ENTERING function. User ID:', currentUserId);

            if (!currentUserId) {
                console.log('GH_DEBUG (VisualIndicator): No user ID, removing class.');
                document.body.classList.remove('quota-met-today');
                return;
            }

            // Use consistent UTC date string calculation
            const todayUTC = new Date();
            const todayDateString = new Date(Date.UTC(todayUTC.getUTCFullYear(), todayUTC.getUTCMonth(), todayUTC.getUTCDate())).toISOString().split('T')[0];

            // Log the exact values being used in the query
            console.log('GH_DEBUG (VisualIndicator): Preparing query for quota date:', todayDateString, 'User ID:', currentUserId);

            try {
                // Use maybeSingle for consistency
                const { data, error } = await supabaseClient
                    .from('daily_quotas_met')
                    .select('id') // Select any column
                    .eq('user_id', currentUserId)
                    .eq('quota_date', todayDateString)
                    .maybeSingle(); // Returns the single row object or null

                // Log the raw response
                console.log('GH_DEBUG (VisualIndicator): Query response:', { data, error });

                if (error) {
                    console.error('GH_DEBUG (VisualIndicator): Error during SELECT query:', error);
                    document.body.classList.remove('quota-met-today'); // Assume not met on error
                } else if (data) {
                    // 'data' is the row object if found, null otherwise
                    console.log('GH_DEBUG (VisualIndicator): SELECT found record. Applying class.');
                    document.body.classList.add('quota-met-today');
                } else {
                    // 'data' is null, meaning no record found
                    console.log('GH_DEBUG (VisualIndicator): SELECT did NOT find record. Removing class.');
                    document.body.classList.remove('quota-met-today');
                }

            } catch (err) {
               console.error('GH_DEBUG (VisualIndicator): CATCH block: Exception during SELECT attempt:', err);
               document.body.classList.remove('quota-met-today');
            }
            console.log('GH_DEBUG (VisualIndicator): EXITING function.');
        }

        // TODO: *** MODIFY: Set this ID to the current unit number (as a string) ***
        // This MUST match the unitId used in allUnitsData.js for this unit.
        const UNIT_ID = 'X'; // Example: '1', '2', '10', etc.

        // Supabase initialization (Keep as is)
        const SUPABASE_URL = 'https://rmqetzxoqupnggltuzqf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtcWV0enhvcXVwbmdnbHR1enFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3MjM2NzAsImV4cCI6MjA1OTI5OTY3MH0.9I56L1kC_4JJr_u9LuDgQ2ZV5C0y_-yic828UeCiuUk';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        
        // --- Single Global Bookmark Functions (Supabase) ---
        // ... (Keep all bookmark functions exactly as they are in the working version) ...
        let currentGlobalBookmark = null; 
        async function fetchCurrentUserBookmark() {
             if (!currentUserId) { console.log("Fetch Bookmark: No user ID."); return null; }
             console.log("Fetch Bookmark: Fetching for user ID:", currentUserId);
             try {
                 const { data, error } = await supabaseClient.from('user_bookmarks').select('*').eq('user_id', currentUserId).maybeSingle(); 
                 if (error) { console.error('Error fetching bookmark:', error); return null; }
                 console.log("Fetch Bookmark: Data received:", data); return data;
             } catch (err) { console.error('Exception fetching bookmark:', err); return null; }
        }
        async function setBookmark(unitId, itemId, itemType, itemName, itemUrl, itemAltUrl) {
             if (!currentUserId) { alert('Please identify yourself (enter username) to set a bookmark.'); return; }
             let absoluteItemUrl = itemUrl; /* ... (URL conversion logic remains) ... */ 
             if (itemUrl && !itemUrl.startsWith('http') && !itemUrl.startsWith('#')) { absoluteItemUrl = new URL(itemUrl, window.location.href).href; } 
             else if (itemUrl && itemUrl.startsWith('#')) { absoluteItemUrl = new URL(itemUrl, window.location.href).href; } 
             let absoluteAltUrl = null; /* ... (Alt URL conversion logic remains) ... */ 
             if (itemAltUrl) { if (!itemAltUrl.startsWith('http') && !itemAltUrl.startsWith('#')) { absoluteAltUrl = new URL(itemAltUrl, window.location.href).href; } else if (itemAltUrl.startsWith('#')) { absoluteAltUrl = new URL(itemAltUrl, window.location.href).href; } else { absoluteAltUrl = itemAltUrl; } }
             const bookmarkData = { user_id: currentUserId, unit_id: unitId, item_id: itemId, item_type: itemType, item_name: itemName, item_url: absoluteItemUrl, item_alt_url: absoluteAltUrl };
             try {
                 console.log('Setting bookmark with data:', bookmarkData);
                 const { data, error } = await supabaseClient.from('user_bookmarks').upsert(bookmarkData, { onConflict: 'user_id', returning: "representation" }).select().single(); 
                 if (error) { console.error('Error setting bookmark:', error); alert('Failed to set bookmark. Please check console and try again.'); } 
                 else { console.log('Bookmark set successfully in Supabase.'); currentGlobalBookmark = data; await displayGlobalBookmarkIndicator(); }
             } catch (err) { console.error('Exception setting bookmark:', err); alert('An error occurred while setting the bookmark.'); }
        }
        async function removeBookmark() {
            if (!currentUserId) { console.log("Remove Bookmark: No user ID."); return; }
            try {
                console.log('Removing bookmark for user ID:', currentUserId);
                const { error } = await supabaseClient.from('user_bookmarks').delete().eq('user_id', currentUserId); 
                if (error) { console.error('Error removing bookmark:', error); alert('Failed to remove bookmark. Please check console and try again.'); } 
                else { console.log('Bookmark removed successfully from Supabase.'); currentGlobalBookmark = null; await displayGlobalBookmarkIndicator(); }
            } catch (err) { console.error('Exception removing bookmark:', err); alert('An error occurred while removing the bookmark.'); }
        }
        function updateAllBookmarkButtons() {
            console.log("Updating all bookmark buttons based on state:", currentGlobalBookmark);
            document.querySelectorAll('button.bookmark-toggle-btn').forEach(button => {
                const unitId = button.dataset.bookmarkUnit; /* ... (rest of button update logic remains) ... */ 
                const itemId = button.dataset.bookmarkItem; const itemType = button.dataset.bookmarkType; const itemName = button.dataset.bookmarkName; const itemUrl = button.dataset.bookmarkUrl; const itemAltUrl = button.dataset.bookmarkAltUrl; let isThisTheBookmark = false;
                if (currentGlobalBookmark && unitId && itemId && itemType) { isThisTheBookmark = ( String(currentGlobalBookmark.unit_id) === String(unitId) && String(currentGlobalBookmark.item_id) === String(itemId) && String(currentGlobalBookmark.item_type) === String(itemType) ); }
                const icon = button.querySelector('svg');
                if (isThisTheBookmark) { button.classList.add('bookmarked-active'); button.title = "This is your current bookmark (Click to remove)"; if (icon) icon.innerHTML = `<path fill-rule="evenodd" d="M5 5a2 2 0 012-2h6a2 2 0 012 2v12l-5-3-5 3V5z" clip-rule="evenodd"></path>`; (function(currentButton) { currentButton.onclick = (event) => { event.stopPropagation(); removeBookmark(); }; })(button); } 
                else { button.classList.remove('bookmarked-active'); button.title = "Set as Bookmark"; if (icon) icon.innerHTML = `<path d="M5 4.75C5 3.784 5.784 3 6.75 3h6.5c.966 0 1.75.784 1.75 1.75v13.5a.75.75 0 01-1.227.548L10 15.56l-3.773 2.288A.75.75 0 015 17.25V4.75zm1.75-.25a.25.25 0 00-.25.25v11.462l3.023-1.833a.75.75 0 01.69-.001L13.25 16.21V4.75a.25.25 0 00-.25-.25h-6.5z"></path>`; (function(currentButton, uId, iId, iType, iName, iUrl, iAltUrl) { currentButton.onclick = (event) => { event.stopPropagation(); setBookmark(uId, iId, iType, iName, iUrl, iAltUrl); }; })(button, unitId, itemId, itemType, itemName, itemUrl, itemAltUrl); }
            });
        }
        async function displayGlobalBookmarkIndicator() {
            const indicator = document.getElementById('global-bookmark-indicator'); /* ... (rest of display logic remains) ... */ 
            if (!indicator) return; 
            if (!currentUserId) { indicator.innerHTML = ''; indicator.style.display = 'none'; currentGlobalBookmark = null; updateAllBookmarkButtons(); return; }
            indicator.innerHTML = '<span class="text-xs text-gray-500">Loading bookmark...</span>'; indicator.style.display = 'block'; 
            currentGlobalBookmark = await fetchCurrentUserBookmark(); 
            if (currentGlobalBookmark) { 
                const jumpUrl = currentGlobalBookmark.item_url; const jumpTarget = '_blank'; let isAnchorLink = false; 
                try { const currentBaseUrl = window.location.origin + window.location.pathname; const bookmarkUrlObj = new URL(jumpUrl); const bookmarkBaseUrl = bookmarkUrlObj.origin + bookmarkUrlObj.pathname; if (bookmarkBaseUrl === currentBaseUrl && bookmarkUrlObj.hash) { isAnchorLink = true; } } catch(e) {} 
                const finalJumpTarget = isAnchorLink ? '_self' : jumpTarget; 
                const hasAltUrl = currentGlobalBookmark.item_alt_url !== null && currentGlobalBookmark.item_alt_url !== undefined; 
                const altUrlButton = hasAltUrl ? `<a href="${currentGlobalBookmark.item_alt_url}" target="_blank" class="px-1.5 py-0.5 bg-green-500 hover:bg-green-600 text-white text-xs rounded" title="Alternate Link (Drive/YouTube)">Alt</a>` : '';
                indicator.innerHTML = `<div class="bg-yellow-100 border border-yellow-300 text-yellow-800 text-sm p-2 rounded-md shadow flex items-center justify-between gap-2"><div class="flex items-center gap-1 overflow-hidden"><svg class="w-4 h-4 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 5a2 2 0 012-2h6a2 2 0 012 2v12l-5-3-5 3V5z" clip-rule="evenodd"></path></svg><span class="font-medium flex-shrink-0">Bookmark:</span><span class="truncate" title="${currentGlobalBookmark.item_name}">${currentGlobalBookmark.item_name} (Unit ${currentGlobalBookmark.unit_id})</span></div><div class="flex items-center gap-1 flex-shrink-0"><a href="${jumpUrl}" target="${finalJumpTarget}" class="px-1.5 py-0.5 bg-yellow-500 hover:bg-yellow-600 text-white text-xs rounded" title="Jump to Bookmark">Go</a> ${altUrlButton} <button onclick="removeBookmark()" class="px-1.5 py-0.5 bg-yellow-200 hover:bg-yellow-300 text-yellow-900 text-xs rounded" title="Clear Bookmark">Clear</button></div></div>`; 
                indicator.style.display = 'block'; 
            } else { indicator.innerHTML = ''; indicator.style.display = 'none'; }
            updateAllBookmarkButtons();
        }
        // --- End Single Global Bookmark Functions ---


        // Global user variables (Keep as is)
        let currentUsername = null;
        let currentUserId = null;
        
        // User identification function (Keep as is)
        async function identifyUser() {
            // ... (Keep this function exactly as it is in the working version) ...
             currentUsername = localStorage.getItem('apStatsUsername'); currentUserId = parseInt(localStorage.getItem('apStatsUserId'), 10) || null;
             if (!currentUsername) { const username = prompt("Enter your username (visible to others):"); if (!username) { console.warn("User identification cancelled or empty username entered"); return; } localStorage.setItem('apStatsUsername', username); currentUsername = username; currentUserId = null; localStorage.removeItem('apStatsUserId'); }
             if (currentUsername && currentUserId) { try { const { data: userCheck, error: checkError } = await supabaseClient.from('users').select('id').eq('id', currentUserId).maybeSingle(); if (checkError) { throw checkError; } if (!userCheck) { console.warn('User ID found in localStorage but not in DB. Attempting to recreate user.'); currentUserId = null; localStorage.removeItem('apStatsUserId'); } else { console.log(`User ID ${currentUserId} verified in DB for ${currentUsername}`); } } catch (error) { console.error('Error validating user ID in DB:', error); currentUserId = null; localStorage.removeItem('apStatsUserId'); } }
             if (currentUsername && !currentUserId) { try { const result = await supabaseClient.from('users').select('id').eq('username', currentUsername).maybeSingle(); if (result.error && result.error.message !== 'Row not found') { throw result.error; } if (result.data) { currentUserId = result.data.id; } else { const insertResult = await supabaseClient.from('users').insert({ username: currentUsername }).select().single(); if (insertResult.error) { throw insertResult.error; } currentUserId = insertResult.data.id; } if (currentUserId) { localStorage.setItem('apStatsUserId', currentUserId); } await updateQuotaMetVisualIndicator(); console.log(`User identified: ${currentUsername} (ID: ${currentUserId})`); } catch (error) { console.error("Error connecting to database:", error); alert('Could not connect to online progress tracker. Progress will only be saved locally.'); currentUserId = null; } }
        }
        
        // Function to save completion data to Supabase (Keep as is)
        async function saveCompletionToSupabase(itemType, itemIdentifier, unitId) {
            // ... (Keep this function exactly as it is in the working version) ...
             console.log('DEBUG: >>> Entering saveCompletionToSupabase. User ID:', currentUserId, 'Item:', itemType, 'ID:', itemIdentifier, 'Unit:', unitId);
             if (!currentUserId) { console.warn('DEBUG: >>> No user ID found inside saveCompletionToSupabase. Skipping Supabase save.'); return; }
             const completionData = { user_id: currentUserId, item_type: itemType, item_identifier: itemIdentifier, unit_id: unitId, completed_at: new Date().toISOString() };
             console.log('DEBUG: >>> Preparing to insert this data:', completionData);
             try { console.log('DEBUG: >>> Calling supabaseClient.from(\'completions\').insert()...'); const { data, error } = await supabaseClient .from('completions') .insert(completionData); console.log('DEBUG: >>> Supabase insert response:', { data, error }); if (error) { console.error('DEBUG: >>> Supabase insert returned an error object:', error); } else { console.log(`DEBUG: >>> Completion save to Supabase seems successful: ${itemType} - ${itemIdentifier}`); debouncedQuotaCheck(); } } 
             catch (error) { console.error('DEBUG: >>> CATCH block: Error during Supabase insert attempt:', error); if (error.message && error.message.includes('Failed to fetch')) { console.log('DEBUG: Network error detected, queueing completion locally.'); try { let queue = JSON.parse(localStorage.getItem('offlineCompletionQueue') || '[]'); completionData.queueTimestamp = Date.now(); queue.push(completionData); localStorage.setItem('offlineCompletionQueue', JSON.stringify(queue)); console.log('DEBUG: Successfully queued completion data for later sync.'); } catch (queueError) { console.error('Failed to save completion to offline queue:', queueError); } } }
             console.log('DEBUG: >>> Exiting saveCompletionToSupabase.');
        }
        
        // Function to delete completion data from Supabase (Keep as is)
        async function deleteCompletionFromSupabase(itemType, itemIdentifier, unitId) {
            // ... (Keep this function exactly as it is in the working version) ...
             if (!currentUserId) { console.warn('DEBUG: No user ID found. Skipping Supabase deletion.'); return; }
             console.log(`DEBUG: Attempting to DELETE completion: User=${currentUserId}, Type=${itemType}, ID=${itemIdentifier}, Unit=${unitId}`);
             try { const { error } = await supabaseClient .from('completions') .delete() .match({ user_id: currentUserId, item_type: itemType, item_identifier: itemIdentifier, unit_id: unitId }); if (error) { console.error('DEBUG: Error deleting completion:', error); } else { console.log('DEBUG: Successfully deleted completion from Supabase.'); } } catch (error) { console.error('DEBUG: Exception while deleting completion from Supabase:', error); }
        }
        
        // Function to synchronize offline completion queue with Supabase (Keep as is)
        async function syncOfflineQueue() {
            // ... (Keep this function exactly as it is in the working version) ...
            if (!currentUserId || !navigator.onLine) return; let queue = JSON.parse(localStorage.getItem('offlineCompletionQueue') || '[]'); if (queue.length === 0) { console.log("DEBUG: Offline queue is empty."); return; } console.log(`DEBUG: Attempting to sync ${queue.length} items from offline queue.`); let successfullySyncedTimestamps = []; for (const item of queue) { try { console.log("DEBUG: Attempting sync for item:", item); item.user_id = currentUserId; const { error } = await supabaseClient.from('completions').insert(item); if (error) { console.warn("DEBUG: Failed to sync item from queue:", error, item); } else { console.log("DEBUG: Successfully synced item:", item); successfullySyncedTimestamps.push(item.queueTimestamp); } } catch (syncError) { console.error("DEBUG: Error during individual queue item sync attempt:", syncError, item); } } const newQueue = queue.filter(item => !successfullySyncedTimestamps.includes(item.queueTimestamp)); localStorage.setItem('offlineCompletionQueue', JSON.stringify(newQueue)); console.log(`DEBUG: Offline queue sync complete. ${successfullySyncedTimestamps.length} items synced. ${newQueue.length} items remain.`);
        }
        
        // Function to synchronize local storage progress with Supabase (Keep as is)
        async function syncLocalStorageToSupabase() {
            // ... (Keep this function exactly as it is in the working version) ...
             if (!currentUserId) { console.log("DEBUG (LSSync): No user ID available. Skipping sync."); return; } if (!navigator.onLine) { console.log("DEBUG (LSSync): Browser reports offline. Skipping sync."); return; } if (typeof ALL_UNITS_DATA === 'undefined') { console.log("DEBUG (LSSync): ALL_UNITS_DATA not available. Skipping sync."); return; } console.log("DEBUG (LSSync): Starting sync from Local Storage to Supabase..."); try { console.log("DEBUG (LSSync): Fetching existing completions from Supabase..."); const { data, error } = await supabaseClient .from('completions') .select('unit_id, item_identifier, item_type') .eq('user_id', currentUserId); if (error) { console.error("DEBUG (LSSync): Error fetching completions from Supabase:", error); return; } const supabaseCompletionsSet = new Set(); if (data && Array.isArray(data)) { data.forEach(item => { const uniqueId = `${item.unit_id}_${item.item_type}_${item.item_identifier}`; supabaseCompletionsSet.add(uniqueId); }); } console.log(`DEBUG (LSSync): Found ${supabaseCompletionsSet.size} existing completions in Supabase.`); let itemsToUploadCount = 0; let itemsSkippedCount = 0; let itemsFailedCount = 0; for (const unit of ALL_UNITS_DATA) { const unitNumber = unit.unitId.slice(-1); const localKey = 'apStatsUnit' + unitNumber + 'Progress'; console.log(`DEBUG (LSSync): Checking local storage for unit ${unit.unitId} with key ${localKey}`); const localDataString = localStorage.getItem(localKey); if (localDataString) { try { const localUnitProgress = JSON.parse(localDataString); if (Array.isArray(localUnitProgress)) { console.log(`DEBUG (LSSync): Found ${localUnitProgress.length} topics in local storage for unit ${unit.unitId}`); for (const topicProgress of localUnitProgress) { if (topicProgress.videos && Array.isArray(topicProgress.videos)) { for (const video of topicProgress.videos) { if (video.completed === true) { const videoUrl = video.url || video.altUrl; const uniqueId = `${unit.unitId}_video_${videoUrl}`; if (!supabaseCompletionsSet.has(uniqueId)) { console.log(`DEBUG (LSSync): Found locally completed video missing in Supabase: ${uniqueId}`); const completionData = { user_id: currentUserId, item_type: 'video', item_identifier: videoUrl, unit_id: unit.unitId, completed_at: video.completionDate || new Date().toISOString() }; itemsToUploadCount++; try { const { error } = await supabaseClient .from('completions') .insert(completionData); if (error) { console.error(`DEBUG (LSSync): Failed to upload video completion to Supabase: ${uniqueId}`, error); itemsFailedCount++; } else { console.log(`DEBUG (LSSync): Successfully uploaded video completion to Supabase: ${uniqueId}`); supabaseCompletionsSet.add(uniqueId); } } catch (insertError) { console.error(`DEBUG (LSSync): Error during video completion upload: ${uniqueId}`, insertError); itemsFailedCount++; } } else { itemsSkippedCount++; } } } } if (topicProgress.quizzes && Array.isArray(topicProgress.quizzes)) { for (const quiz of topicProgress.quizzes) { if (quiz.completed === true) { const uniqueId = `${unit.unitId}_quiz_${quiz.quizId}`; if (!supabaseCompletionsSet.has(uniqueId)) { console.log(`DEBUG (LSSync): Found locally completed quiz missing in Supabase: ${uniqueId}`); const completionData = { user_id: currentUserId, item_type: 'quiz', item_identifier: quiz.quizId, unit_id: unit.unitId, completed_at: quiz.completionDate || new Date().toISOString() }; itemsToUploadCount++; try { const { error } = await supabaseClient .from('completions') .insert(completionData); if (error) { console.error(`DEBUG (LSSync): Failed to upload quiz completion to Supabase: ${uniqueId}`, error); itemsFailedCount++; } else { console.log(`DEBUG (LSSync): Successfully uploaded quiz completion to Supabase: ${uniqueId}`); supabaseCompletionsSet.add(uniqueId); } } catch (insertError) { console.error(`DEBUG (LSSync): Error during quiz completion upload: ${uniqueId}`, insertError); itemsFailedCount++; } } else { itemsSkippedCount++; } } } } } else { console.log(`DEBUG (LSSync): Local data for unit ${unit.unitId} is not an array. Skipping.`); } } catch (parseError) { console.error(`DEBUG (LSSync): Error parsing local data for unit ${unit.unitId}:`, parseError); } } else { console.log(`DEBUG (LSSync): No local data found for unit ${unit.unitId}`); } } console.log(`DEBUG (LSSync): Sync finished. Items to upload check: ${itemsToUploadCount}. Items skipped (already in DB): ${itemsSkippedCount}. Items failed to upload: ${itemsFailedCount}.`); } catch (error) { console.error("DEBUG (LSSync): Error during localStorage to Supabase sync:", error); }
        }
        
        // Flowchart Mermaid Definition (Keep as is)
        const flowchartDefinition = `flowchart TD 
            A[Start Learning Session] --> B[Gather All Materials]; B --> C[Open Grok AI Assistant]; C --> D[Copy & Paste Tutor Prompt]; D --> E[Open Study Materials Tab]; E --> F[Download Question & Answer PDFs]; F --> G[Attach PDFs to Grok Conversation]; G --> H["Watch Topic Video\n(Look for (+) for videos with backups)"]; 
            H --> AP{AP Classroom\\nAvailable?}; AP -->|Yes| WA[Watch AP Classroom Video]; AP -->|No| WG["Use Google Drive Backup Video\n(Hover over (+) for the link)"]; WA --> I{Confused about\\nsomething?}; WG --> I; 
            I -->|Yes| J[Pause Video]; J --> K[Ask Grok for Help]; K --> L[Return to Video]; L --> I; 
            I -->|No| M[Finish Video]; M --> N[Work Through Practice Problems with Grok]; N --> O{All Problems\\nCompleted?}; O -->|No| N; O -->|Yes| P[Mark Topic as Completed]; P --> Q{All Topics\\nCompleted?}; Q -->|No| R[Proceed to Next Topic]; R --> E; Q -->|Yes| S[Tackle Capstone Challenge]; 
            classDef blueBox fill:#d4f1f9,stroke:#05b2dc,stroke-width:2px; classDef greenBox fill:#d8f3dc,stroke:#2d6a4f,stroke-width:2px; classDef yellowBox fill:#fefae0,stroke:#bc6c25,stroke-width:2px; classDef purpleBox fill:#e0c3fc,stroke:#7b2cbf,stroke-width:2px; classDef redBox fill:#ffccd5,stroke:#d90429,stroke-width:2px; 
            class A,B,C,D blueBox; class E,F,G blueBox; class H,AP,WA,WG,I,J,K,L yellowBox; class M,N,O greenBox; class P,Q,R purpleBox; class S redBox;`;
        
        // Grok Prompt (Keep as is)
        const grokPrompt = `You are an expert AP Statistics tutor... [Grok Prompt Text Remains Unchanged] ... Thank you for helping me prepare for my AP Statistics exam!`;
        
        // Initialize Mermaid (Keep as is)
        mermaid.initialize({ startOnLoad: true, theme: 'default', securityLevel: 'loose', logLevel: 5, flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'cardinal', diagramPadding: 8, nodeSpacing: 30, rankSpacing: 50 } });
        
        // Function to render the flowchart (Keep as is)
        function renderFlowchart() { /* ... (Keep this function body as is) ... */ 
             const container = document.getElementById('flowchart'); while (container.firstChild) { container.removeChild(container.firstChild); } const pre = document.createElement('pre'); pre.className = 'mermaid'; pre.textContent = flowchartDefinition; container.appendChild(pre); try { mermaid.contentLoaded(); } catch (e) { console.error('Mermaid parsing error:', e); }
        }
        
        // Study Materials and PDF Organization

        // TODO: *** MODIFY: Replace this entire array with the specific topic data for the new unit. ***
        // Follow the exact structure shown in the comments below.
        // - `id`: Unique identifier for the topic (e.g., "1-1", "1-2").
        // - `name`: Display name of the topic (e.g., "Topic 1.1").
        // - `description`: Brief description of the topic content.
        // - `videos`: Array of video objects.
        //      - `url`: Link to AP Classroom video (or primary video source).
        //      - `altUrl`: Link to backup video (e.g., Google Drive). Optional.
        //      - `completed`, `completionDate`: Leave as false/null initially.
        // - `quizzes`: Array of quiz objects.
        //      - `questionPdf`: Path to the questions PDF (e.g., "pdfs/unit1/unit1_section1.1_quiz.pdf").
        //      - `answersPdf`: Path to the answers PDF.
        //      - `quizId`: Unique identifier for the quiz (e.g., "1-1_q1"). MUST be unique within the unit.
        //      - `completed`, `completionDate`: Leave as false/null initially.
        // - `isCapstone`: Set to `true` ONLY for the final capstone/progress check topic(s). Default is false.
        // - `current`: Leave as `false`. The script determines the current topic automatically.
        const pdfFiles = [
            /* --- START: Example Unit Structure ---

            {
              id: "X-1", // Example: "1-1" for Unit 1, Topic 1
              name: "Topic X.1: [Topic Title]",
              description: "[Brief description of Topic X.1]",
              videos: [
                  { // At least one video object, even if only altUrl exists
                      url: "[AP Classroom URL for Video 1]", // Optional if only altUrl exists
                      altUrl: "[Google Drive URL for Video 1]", // Optional
                      completed: false,
                      completionDate: null
                  },
                  // Add more video objects if the topic has multiple videos
                  // { url: "[URL Video 2]", altUrl: "[Alt URL Video 2]", completed: false, completionDate: null } 
              ],
              quizzes: [
                  { // Optional: Add quiz objects if practice PDFs exist
                      questionPdf: "pdfs/[unit_folder]/[unitX_sectionX.1_quiz].pdf", // Adjust path
                      answersPdf: "pdfs/[unit_folder]/[unitX_sectionX.1_answers].pdf", // Adjust path
                      quizId: "X-1_q1", // Example: "1-1_q1". MUST BE UNIQUE within the unit.
                      completed: false,
                      completionDate: null
                  }
                  // Add more quiz objects if the topic has multiple quizzes/parts
                  // { questionPdf: "...", answersPdf: "...", quizId: "X-1_q2", completed: false, ... } 
              ],
              current: false // Always leave as false initially
            },

            {
              id: "X-2", 
              name: "Topic X.2: [Another Topic Title]",
              description: "[Description for Topic X.2]",
              videos: [ // Example: Topic with only video(s)
                 { url: "[URL Video 1]", altUrl: "[Alt URL Video 1]", completed: false, completionDate: null } 
              ],
              quizzes: [], // Empty array if no quizzes
              current: false 
            },

            // ... Add all other topics for the unit following the structure ...

            { // --- Example: Capstone / Progress Check Topic ---
              id: "X-capstone", // Or specific ID like "X-7" if it's the last numbered topic
              name: "Unit X Progress Check",
              description: "Capstone Assessment for Unit X",
              videos: [], // Often no videos for progress checks
              quizzes: [
                  { // Example: FRQ part
                      questionPdf: "pdfs/[unit_folder]/[unitX_pc_frq].pdf",
                      answersPdf: "pdfs/[unit_folder]/[unitX_pc_frq_answers].pdf",
                      quizId: "X-capstone_frq", // Unique ID
                      completed: false,
                      completionDate: null
                  },
                  { // Example: MCQ part (can be split if needed)
                      questionPdf: "pdfs/[unit_folder]/[unitX_pc_mcq].pdf", // Or just answer key
                      answersPdf: "pdfs/[unit_folder]/[unitX_pc_mcq_answers].pdf",
                      quizId: "X-capstone_mcq", // Unique ID
                      completed: false,
                      completionDate: null
                  }
              ],
              isCapstone: true, // Set true for the capstone
              current: false
            }

            --- END: Example Unit Structure --- */
        ];
        
        // Function to create a topic card (Keep as is)
        function createTopicCard(topic, forNextTopic = false) { /* ... (Keep this function body as is) ... */ 
             let isCapstoneLocked = false; if (topic.isCapstone && !forNextTopic) { const nonCapstonePdfs = pdfFiles.filter(p => !p.isCapstone); const allPreviousCompleted = nonCapstonePdfs.every(p => p.videos.every(v => v.completed) && p.quizzes.every(q => q.completed)); isCapstoneLocked = !allPreviousCompleted; } const isCompleted = topic.videos.every(v => v.completed) && topic.quizzes.every(q => q.completed); let cardClasses = 'bg-white rounded-lg shadow-md p-4 transition duration-300 '; if (isCompleted) { cardClasses += 'border-2 border-green-500 '; } else if (topic.isCapstone) { cardClasses += 'border-2 border-red-500 bg-red-50 '; } else if (topic.current) { cardClasses += 'border-2 border-blue-500 bg-blue-50 '; } else { cardClasses += 'border border-gray-200 '; } let statusIcon = ''; if (isCompleted) { statusIcon = '<span class="text-white bg-green-500 rounded-full w-6 h-6 flex items-center justify-center mr-2"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></span>'; } else if (topic.isCapstone) { statusIcon = '<span class="text-white bg-red-500 rounded-full w-6 h-6 flex items-center justify-center mr-2">🏆</span>'; } else if (topic.current) { statusIcon = '<span class="text-white bg-blue-500 rounded-full w-6 h-6 flex items-center justify-center mr-2"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"></path></svg></span>'; } else { statusIcon = '<span class="text-gray-400 bg-gray-100 rounded-full w-6 h-6 flex items-center justify-center mr-2"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd"></path></svg></span>'; } let statusBadge = ''; if (isCompleted) { statusBadge = '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Completed</span>'; } else if (topic.isCapstone) { statusBadge = '<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">Capstone Challenge</span>'; } else if (topic.current) { statusBadge = '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Current Focus</span>'; } let quizLinksHTML = ''; /* ... (Quiz Link Generation Logic remains) ... */ if(topic.quizzes.length>0){topic.quizzes.forEach(quiz=>{if(quiz.questionPdf){let linkText="Questions PDF";if(topic.isCapstone){/* Adjust text based on quizId for capstone */}quizLinksHTML+=`<div class="flex items-center mb-2"><input type="checkbox" id="quiz-${topic.id}-${quiz.quizId}-questions" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 cursor-pointer" ${quiz.completed?'checked':''} data-topic-id="${topic.id}" data-item-type="quiz" data-quiz-id="${quiz.quizId}" onchange="handleItemCompletionChange(event)" ${isCapstoneLocked?'disabled':''}> <a href="${quiz.questionPdf}" target="_blank" download class="flex items-center text-blue-600 hover:text-blue-800 bg-white p-2 rounded border border-blue-200 hover:bg-blue-50 flex-grow"><svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>${linkText}</a><button class="p-1 ml-2 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0" title="Set as Bookmark" data-bookmark-unit="${UNIT_ID}" data-bookmark-item="${topic.id}-${quiz.quizId}-q" data-bookmark-type="quiz" data-bookmark-name="${topic.name} - ${linkText}" data-bookmark-url="${quiz.questionPdf}"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="...bookmark icon path..."></path></svg></button></div>`;}if(quiz.answersPdf){const answerTitle=topic.isCapstone?/* Adjust text based on quizId */:"Answers PDF";quizLinksHTML+=`<div class="flex items-center justify-between mb-2"><div class="flex items-center"><input type="checkbox" id="quiz-${topic.id}-${quiz.quizId}-answers" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 cursor-pointer" ${quiz.completed?'checked':''} data-topic-id="${topic.id}" data-item-type="quiz" data-quiz-id="${quiz.quizId}" onchange="handleItemCompletionChange(event)" ${isCapstoneLocked?'disabled':''}> <a href="${quiz.answersPdf}" target="_blank" download class="flex items-center text-blue-600 hover:text-blue-800 bg-white p-2 rounded border border-blue-200 hover:bg-blue-50 flex-grow"><svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>${answerTitle}</a><button class="p-1 ml-2 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0" title="Set as Bookmark" data-bookmark-unit="${UNIT_ID}" data-bookmark-item="${topic.id}-${quiz.quizId}-a" data-bookmark-type="quiz" data-bookmark-name="${topic.name} - ${answerTitle}" data-bookmark-url="${quiz.answersPdf}"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="...bookmark icon path..."></path></svg></button></div></div>`;}})}if(topic.quizzes.length===0){quizLinksHTML+=`<div class="p-2 bg-blue-50 rounded text-blue-700 text-sm mb-2"><svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>This topic has video content only (no practice PDFs)</div>`;} let videoLinksHTML = ''; /* ... (Video Link Generation Logic remains) ... */ if(topic.videos.length>0){topic.videos.forEach((video,index)=>{const videoNumber=topic.videos.length>1?` ${index+1}`:'';if(video.url){videoLinksHTML+=`<div class="flex items-center justify-between mb-2"><div class="flex items-center"><input type="checkbox" id="video-${topic.id}-${index}" class="mr-2 h-4 w-4 text-yellow-600 focus:ring-yellow-500 cursor-pointer" ${video.completed?'checked':''} data-topic-id="${topic.id}" data-item-type="video" data-item-url="${video.url}" onchange="handleItemCompletionChange(event)" ${isCapstoneLocked?'disabled':''}> <a href="${video.url}" target="_blank" class="flex items-center text-yellow-600 hover:text-yellow-800 bg-white p-2 rounded border border-yellow-200 hover:bg-yellow-50 group relative flex-grow"><svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path></svg>Watch Topic Video${videoNumber}${video.altUrl?`<span class="ml-1 text-xs bg-green-100 text-green-800 px-1 rounded flex-shrink-0"><svg class="w-3 h-3 inline-block" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></span><span class="absolute top-full left-0 mt-1 hidden group-hover:block bg-white border border-gray-200 rounded p-2 shadow-md text-xs text-gray-700 w-48 z-50">If AP Classroom is down, <a href="${video.altUrl}" class="text-blue-600 hover:text-blue-800">click here</a> for the backup Google Drive video.</span>`:''}<!-- Bookmark Button --><button class="p-1 ml-2 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0" title="Set as Bookmark" data-bookmark-unit="${UNIT_ID}" data-bookmark-item="${topic.id}-video-${index}" data-bookmark-type="video" data-bookmark-name="${topic.name} - Video${videoNumber}" data-bookmark-url="${video.url}" data-bookmark-alt-url="${video.altUrl||''}"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="...bookmark icon path..."></path></svg></button></a></div></div>`;}else if(video.altUrl){videoLinksHTML+=`<div class="flex items-center justify-between mb-2"><div class="flex items-center"><input type="checkbox" id="video-${topic.id}-${index}-alt" class="mr-2 h-4 w-4 text-yellow-600 focus:ring-yellow-500 cursor-pointer" ${video.completed?'checked':''} data-topic-id="${topic.id}" data-item-type="video" data-item-url="${video.altUrl}" onchange="handleItemCompletionChange(event)" ${isCapstoneLocked?'disabled':''}> <a href="${video.altUrl}" target="_blank" class="flex items-center text-yellow-600 hover:text-yellow-800 bg-white p-2 rounded border border-yellow-200 hover:bg-yellow-50 flex-grow"><svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path></svg>Watch Topic Video${videoNumber} (Google Drive)</a><!-- Bookmark Button --><button class="p-1 ml-2 text-gray-400 hover:text-blue-600 bookmark-toggle-btn flex-shrink-0" title="Set as Bookmark" data-bookmark-unit="${UNIT_ID}" data-bookmark-item="${topic.id}-video-${index}-alt" data-bookmark-type="video" data-bookmark-name="${topic.name} - Video${videoNumber} (Google Drive)" data-bookmark-url="${video.altUrl}" data-bookmark-alt-url="${video.url||''}"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="...bookmark icon path..."></path></svg></button></div></div>`;}})} const cardHTML = ` <div id="topic-card-${topic.id}" class="${cardClasses}"><div class="flex items-start justify-between mb-3"><div class="flex items-center">${statusIcon}<h3 class="text-lg font-semibold">${topic.name}</h3></div>${statusBadge}</div><p class="text-gray-700 mb-4">${topic.description}</p>${topic.isCapstone&&isCapstoneLocked?`<div class="mb-3 p-3 bg-amber-50 border border-amber-200 rounded-md text-amber-800"><div class="flex items-center"><svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 116 0z" clip-rule="evenodd"></path></svg><span>Complete all other topics first!</span></div></div>`:''}<div class="space-y-1 mb-3">${quizLinksHTML}${videoLinksHTML}</div>${isCompleted||(topic.isCapstone&&isCapstoneLocked)?'':`<button class="w-full mt-2 bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded-md mark-completed-btn" data-topic-id="${topic.id}"><svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>Mark Topic as Completed</button>`}</div> `; return cardHTML;
        }
        
        // Add styling for the pulse animation and completed state (Keep as is)
        const style = document.createElement('style'); style.textContent = ` @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } } .pulse-animation { animation: pulse 1s ease-in-out 2; } .completed-state { opacity: 0.8; position: relative; } .completed-state::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.05); pointer-events: none; z-index: 1; } .completed-state .topic-card:not(.capstone-completed) { filter: grayscale(50%); } .capstone-highlight { border: 2px solid #ef4444 !important; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.2), 0 2px 4px -1px rgba(239, 68, 68, 0.1) !important; } `; document.head.appendChild(style);
        
        // Function to check if all topics are completed (Keep as is)
        function checkAllTopicsCompleted() { /* ... (Keep this function body as is) ... */ 
            let totalItems=0; let completedItems=0; pdfFiles.forEach(topic=>{topic.videos.forEach(video=>{totalItems++;if(video.completed)completedItems++;});topic.quizzes.forEach(quiz=>{totalItems++;if(quiz.completed)completedItems++;});}); const allCompleted=totalItems>0&&completedItems===totalItems; const completedContainer=document.getElementById('all-completed-container'); const topicCardsContainer=document.getElementById('topic-cards-container'); const studyMaterialsTab=document.getElementById('content-study-materials'); if(allCompleted){completedContainer.classList.remove('hidden'); document.getElementById('next-topic-container').classList.add('hidden'); topicCardsContainer.classList.add('completed-state'); const capstoneCard=document.getElementById(`topic-card-exam-frq2`); if(capstoneCard){capstoneCard.classList.add('capstone-highlight');} studyMaterialsTab.classList.add('bg-green-50');}else{completedContainer.classList.add('hidden'); topicCardsContainer.classList.remove('completed-state'); studyMaterialsTab.classList.remove('bg-green-50'); const capstoneCard=document.getElementById(`topic-card-exam-frq2`); if(capstoneCard){capstoneCard.classList.remove('capstone-highlight');}} return allCompleted;
        }
        
        // Function to reset all progress (Keep as is)
        function resetProgress() { /* ... (Keep this function body as is) ... */ 
             if(confirm('Are you sure you want to reset all progress? This cannot be undone.')){pdfFiles.forEach((topic,index)=>{topic.videos.forEach(video=>{video.completed=false;video.completionDate=null;});topic.quizzes.forEach(quiz=>{quiz.completed=false;quiz.completionDate=null;});topic.current=index===0;}); saveTopicProgress(); const currentTopicHeader=document.getElementById('current-topic-header');if(currentTopicHeader){currentTopicHeader.textContent='2. Get Your Current Topic Materials';} const topicsHeader=document.querySelector('.grok-prompt-topics-header');if(topicsHeader){topicsHeader.textContent='Quick Access to All Topics';} populateTopicCards(); updateCurrentTopicInfo(); populateQuickAccessTopics(); updateAllBookmarkButtons(); document.getElementById('all-completed-container').classList.add('hidden'); const firstCard=document.getElementById(`topic-card-${pdfFiles[0].id}`);if(firstCard&&document.getElementById('content-study-materials').classList.contains('active')){firstCard.scrollIntoView({behavior:'smooth',block:'center'});}}
        }
        
        // Function to populate the topic cards (Keep as is)
        function populateTopicCards() { /* ... (Keep this function body as is) ... */ 
            const container=document.getElementById('topic-cards-container');if(!container){console.log('Error: topic-cards-container not found');return;} container.innerHTML=''; const nextIncompleteIndex=pdfFiles.findIndex(topic=>{return!topic.videos.every(v=>v.completed)||!topic.quizzes.every(q=>q.completed);}); if(nextIncompleteIndex>=0){pdfFiles.forEach((topic,index)=>{topic.current=index===nextIncompleteIndex;});} pdfFiles.forEach((topic,index)=>{const isNext=index===nextIncompleteIndex; const cardHTML=createTopicCard(topic,isNext); const tempDiv=document.createElement('div');tempDiv.innerHTML=cardHTML; const cardElement=tempDiv.firstElementChild; const completeButton=cardElement.querySelector('.mark-completed-btn');if(completeButton){completeButton.addEventListener('click',function(){const topicId=this.getAttribute('data-topic-id');markTopicAsCompleted(topicId);});} container.appendChild(cardElement);}); updateProgressBar(); populateTopicSelect(); checkAllTopicsCompleted();
        }
        
        // Function to populate the topic select dropdown (Keep as is)
        function populateTopicSelect() { /* ... (Keep this function body as is) ... */ 
            const select=document.getElementById('topic-select');select.innerHTML='<option value="">Select a topic...</option>';pdfFiles.forEach(topic=>{const option=document.createElement('option');option.value=topic.id;option.textContent=topic.name;select.appendChild(option);});select.addEventListener('change',function(){const selectedTopicId=this.value;if(!selectedTopicId)return;const card=document.getElementById(`topic-card-${selectedTopicId}`);if(card){card.scrollIntoView({behavior:'smooth',block:'center'});card.classList.add('pulse-animation');setTimeout(()=>{card.classList.remove('pulse-animation');},2000);}});
        }
        
        // Function to mark a specific video as completed or not completed (Keep as is)
        function markVideoComplete(topicId, videoUrl, isCompleted) { /* ... (Keep this function body as is) ... */ 
            const topic=pdfFiles.find(t=>t.id===topicId);if(!topic)return;const video=topic.videos.find(v=>v.url===videoUrl||v.altUrl===videoUrl);if(!video)return;video.completed=isCompleted;video.completionDate=isCompleted?new Date().toISOString():null;saveTopicProgress();populateTopicCards();updateCurrentTopicInfo();populateQuickAccessTopics();updateAllBookmarkButtons();updateProgressBar();console.log(`DEBUG: Before Supabase Check. currentUserId:`,currentUserId,`isCompleted:`,isCompleted);if(currentUserId){if(isCompleted){console.log('DEBUG: Item marked complete, attempting to save to Supabase...');saveCompletionToSupabase('video',videoUrl,UNIT_ID);}else{console.log('DEBUG: Item marked incomplete. Attempting to delete from Supabase...');deleteCompletionFromSupabase('video',videoUrl,UNIT_ID);}} debouncedQuotaCheck();
        }
        
        // Function to mark a specific quiz as completed or not completed (Keep as is)
        function markQuizComplete(topicId, quizId, isCompleted) { /* ... (Keep this function body as is) ... */ 
            const topic=pdfFiles.find(t=>t.id===topicId);if(!topic)return;const quiz=topic.quizzes.find(q=>q.quizId===quizId);if(!quiz)return;quiz.completed=isCompleted;quiz.completionDate=isCompleted?new Date().toISOString():null;saveTopicProgress();populateTopicCards();updateCurrentTopicInfo();populateQuickAccessTopics();updateAllBookmarkButtons();updateProgressBar();console.log(`DEBUG: Before Supabase Check. currentUserId:`,currentUserId,`isCompleted:`,isCompleted);if(currentUserId){if(isCompleted){console.log('DEBUG: Item marked complete, attempting to save to Supabase...');saveCompletionToSupabase('quiz',quizId,UNIT_ID);}else{console.log('DEBUG: Item marked incomplete. Attempting to delete from Supabase...');deleteCompletionFromSupabase('quiz',quizId,UNIT_ID);}} debouncedQuotaCheck();
        }
        
        
        // Function to check if daily quota has been met and record it in Supabase (Keep as is)
        async function _performQuotaCheck() { /* ... (Keep this function body exactly as in the working version) ... */ 
            console.log("DEBUG (_performQuotaCheck): Debounced check running..."); if (!currentUserId) { console.log('DEBUG (QuotaCheck): Cannot check daily quota without user ID.'); document.body.classList.remove('quota-met-today'); await updateQuotaMetVisualIndicator(); return; } console.log('DEBUG (QuotaCheck): Calculating dynamic quota targets...'); const { requiredVideosPerDay, requiredQuizzesPerDay, error: quotaError } = await calculateDynamicQuota(); if (quotaError) { console.error(`DEBUG (QuotaCheck): Failed to calculate dynamic quota: ${quotaError}. Aborting check.`); document.body.classList.remove('quota-met-today'); await updateQuotaMetVisualIndicator(); return; } console.log(`DEBUG (QuotaCheck): Dynamic targets: Videos=${requiredVideosPerDay}, Quizzes=${requiredQuizzesPerDay}`); const now = new Date(); const startOfDayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0)); const endOfDayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23, 59, 59, 999)); const todayDateString = startOfDayUTC.toISOString().split('T')[0]; console.log(`DEBUG: Checking completions for UTC date ${todayDateString} from ${startOfDayUTC.toISOString()} to ${endOfDayUTC.toISOString()}`); try { const { data: completionsData, error: completionsError } = await supabaseClient .from('completions') .select('item_type') .eq('user_id', currentUserId) .gte('completed_at', startOfDayUTC.toISOString()) .lte('completed_at', endOfDayUTC.toISOString()); if (completionsError) { console.error('Error fetching today\'s completions:', completionsError); } const videosToday = completionsData ? completionsData.filter(item => item.item_type === 'video').length : 0; const quizzesToday = completionsData ? completionsData.filter(item => item.item_type === 'quiz').length : 0; console.log(`DEBUG (QuotaCheck): Fetched counts for today: Videos=${videosToday}, Quizzes=${quizzesToday}`); const quotaMetNow = videosToday >= requiredVideosPerDay && quizzesToday >= requiredQuizzesPerDay; console.log(`DEBUG: Quota met now (dynamic)? ${quotaMetNow}`); let recordExists = false; try { const { data: quotaStatusData, error: quotaStatusError } = await supabaseClient .from('daily_quotas_met') .select('id') .eq('user_id', currentUserId) .eq('quota_date', todayDateString) .maybeSingle(); if (quotaStatusError) { console.warn('WARN (QuotaCheck): Could not reliably check existing quota record:', quotaStatusError.message); } else { recordExists = (quotaStatusData !== null); console.log(`DEBUG (QuotaCheck - DB Read): Record exists for today? ${recordExists}`); } } catch (readError) { console.error('ERROR (QuotaCheck): Exception during quota status read:', readError); } if (quotaMetNow) { if (!recordExists) { console.log("DEBUG (QuotaCheck - DB): Attempting to INSERT quota record (as read found none)..."); const { error: insertError } = await supabaseClient .from('daily_quotas_met') .insert({ user_id: currentUserId, quota_date: todayDateString }); if (insertError) { const isConflict = insertError.code === '23505' || (insertError.message && insertError.message.includes('duplicate key value violates unique constraint')); if (isConflict) { console.log('DEBUG (QuotaCheck - DB): INSERT failed with Conflict (409). Record MUST exist.'); document.body.classList.add('quota-met-today'); } else { console.error(`DEBUG (QuotaCheck - DB): INSERT failed for other reason: ${insertError.message}`); document.body.classList.remove('quota-met-today'); } } else { console.log('DEBUG (QuotaCheck - DB): INSERT successful.'); document.body.classList.add('quota-met-today'); } } else { console.log("DEBUG (QuotaCheck - DB): Read found record exists and quota is met. Ensuring UI state."); document.body.classList.add('quota-met-today'); } } else { if (recordExists) { console.log("DEBUG (QuotaCheck - DB): Quota NOT met, attempting to DELETE existing record..."); const { error: deleteError } = await supabaseClient .from('daily_quotas_met') .delete() .match({ user_id: currentUserId, quota_date: todayDateString }); if (deleteError) { console.error('Error deleting quota record:', deleteError); } else { console.log('DEBUG (QuotaCheck - DB): DELETE successful.'); document.body.classList.remove('quota-met-today'); } } else { console.log("DEBUG (QuotaCheck - DB): Quota NOT met, no record found. Ensuring UI state."); document.body.classList.remove('quota-met-today'); } } } catch (outerError) { console.error('Error during overall quota check process:', outerError); document.body.classList.remove('quota-met-today'); } console.log('DEBUG (QuotaCheck): Finished check logic, calling displayDailyQuotaStatus for UI text/bars.'); await displayDailyQuotaStatus(); 
        }
        
        // Create the debounced version of the quota check function (Keep as is)
        const debouncedQuotaCheck = debounce(_performQuotaCheck, 750);
        const _debouncedQuotaCheck = debounce(_performQuotaCheck, 500); // Note: Two debounce constants exist, ensure correct one is used or consolidate. Using `debouncedQuotaCheck` below.

        // Function that external code calls to trigger a quota check (Keep as is)
        async function _triggerDebouncedQuotaCheck() { /* ... */ console.log('DEBUG: checkDailyQuotaCompletion called, using debounced implementation'); debouncedQuotaCheck(); } // Changed to use the 750ms version
        async function checkDailyQuotaCompletion() { return _triggerDebouncedQuotaCheck(); }
        
        // Function to mark all videos and quizzes in a topic as completed (Keep as is)
        async function markTopicAsCompleted(topicId) { /* ... (Keep this function body as is) ... */ 
            const topic = pdfFiles.find(t => t.id === topicId); if (!topic) return; console.log(`DEBUG (markTopic): Marking topic ${topicId} as completed.`); const itemsToSave = []; topic.videos.forEach(video => { if (!video.completed) { video.completed = true; video.completionDate = video.completionDate || new Date().toISOString(); const videoIdentifier = video.url || video.altUrl; if (videoIdentifier) { itemsToSave.push({ type: 'video', identifier: videoIdentifier }); console.log(`DEBUG (markTopic): Queued video ${videoIdentifier} for saving.`); } else { console.warn(`DEBUG (markTopic): Skipping video in topic ${topicId} due to missing identifier.`); } } }); topic.quizzes.forEach(quiz => { if (!quiz.completed) { quiz.completed = true; quiz.completionDate = quiz.completionDate || new Date().toISOString(); itemsToSave.push({ type: 'quiz', identifier: quiz.quizId }); console.log(`DEBUG (markTopic): Queued quiz ${quiz.quizId} for saving.`); } }); topic.current = false; const currentIndex = pdfFiles.findIndex(t => t.id === topicId); if (currentIndex >= 0 && currentIndex < pdfFiles.length - 1) { const nextTopic = pdfFiles[currentIndex + 1]; if (nextTopic) { nextTopic.current = true; } } saveTopicProgress(); console.log(`DEBUG (markTopic): Local progress saved for topic ${topicId}.`); if (currentUserId && itemsToSave.length > 0) { console.log(`DEBUG (markTopic): Attempting to save ${itemsToSave.length} items to Supabase for user ${currentUserId}.`); Promise.allSettled(itemsToSave.map(item => saveCompletionToSupabase(item.type, item.identifier, UNIT_ID))).then(async results => { results.forEach((result, index) => { const item = itemsToSave[index]; if (result.status === 'fulfilled') { console.log(`DEBUG (markTopic): Successfully saved ${item.type} ${item.identifier} to Supabase.`); } else { console.error(`DEBUG (markTopic): Failed to save ${item.type} ${item.identifier} to Supabase:`, result.reason); } }); console.log(`DEBUG (markTopic): Triggering quota check after Supabase saves.`); await checkDailyQuotaCompletion(); }); } else if (itemsToSave.length > 0) { console.warn(`DEBUG (markTopic): No user ID or no items needed saving to Supabase. Local state updated.`); console.log(`DEBUG (markTopic): Triggering quota check even without Supabase saves (may rely on local logic if implemented).`); await checkDailyQuotaCompletion(); } else { console.log(`DEBUG (markTopic): No new items were marked complete.`); console.log(`DEBUG (markTopic): Triggering quota check (topic might have been already complete).`); await checkDailyQuotaCompletion(); } populateTopicCards(); updateCurrentTopicInfo(); populateQuickAccessTopics(); updateAllBookmarkButtons(); updateProgressBar(); if (currentIndex >= 0 && currentIndex < pdfFiles.length - 1 && document.getElementById('content-study-materials').classList.contains('active')) { const nextCard = document.getElementById(`topic-card-${pdfFiles[currentIndex + 1]?.id}`); if (nextCard) { setTimeout(() => { nextCard.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100); } }
        }
        
        // Function to update the next topic section (Keep as is)
        function updateNextTopic() { /* ... (Keep this function body as is) ... */ 
             const nextTopicContainer = document.getElementById('next-topic-container'); const nextTopicCard = document.getElementById('next-topic-card'); if (checkAllTopicsCompleted()) { nextTopicContainer.classList.add('hidden'); return; } const nextIncompleteIndex = pdfFiles.findIndex(topic => !topic.completed); if (nextIncompleteIndex >= 0) { nextTopicContainer.classList.remove('hidden'); nextTopicCard.innerHTML = ''; nextTopicCard.appendChild(createTopicCard(pdfFiles[nextIncompleteIndex], true)); } else { nextTopicContainer.classList.add('hidden'); }
        }
        
        // Function to update the progress bar (Keep as is)
        function updateProgressBar() { /* ... (Keep this function body as is) ... */ 
            let totalItems=0; let completedItems=0; pdfFiles.forEach(topic=>{topic.videos.forEach(video=>{totalItems++;if(video.completed)completedItems++;}); topic.quizzes.forEach(quiz=>{totalItems++;if(quiz.completed)completedItems++;});}); const progressPercentage=totalItems>0?(completedItems/totalItems)*100:0; const progressBar=document.getElementById('progress-bar'); progressBar.style.width=`${progressPercentage}%`; if(progressPercentage>10){progressBar.textContent=`${Math.round(progressPercentage)}% Complete (${completedItems}/${totalItems} items)`;}else{progressBar.textContent='';}
        }
        
        // Function to save topic progress to local storage (Keep as is)
        function saveTopicProgress() { /* ... (Keep this function body as is) ... */ 
             const progress = pdfFiles.map(topic => ({ id: topic.id, completed: topic.videos.every(v => v.completed) && topic.quizzes.every(q => q.completed), current: topic.current, videos: topic.videos.map(video => ({ url: video.url, altUrl: video.altUrl, completed: video.completed, completionDate: video.completionDate })), quizzes: topic.quizzes.map(quiz => ({ quizId: quiz.quizId, completed: quiz.completed, completionDate: quiz.completionDate })) })); localStorage.setItem('apStatsUnit' + UNIT_ID + 'Progress', JSON.stringify(progress));
        }
        
        // Function to load topic progress from local storage (Keep as is)
        function loadTopicProgress() { /* ... (Keep this function body as is) ... */ 
            const savedProgress=localStorage.getItem('apStatsUnit'+UNIT_ID+'Progress');if(savedProgress){const progress=JSON.parse(savedProgress);progress.forEach(savedTopic=>{const topic=pdfFiles.find(t=>t.id===savedTopic.id);if(topic){topic.current=savedTopic.current;if(savedTopic.videos&&Array.isArray(savedTopic.videos)){savedTopic.videos.forEach((savedVideo,index)=>{const videoMatch=topic.videos.find(v=>v.url===savedVideo.url)||(index<topic.videos.length?topic.videos[index]:null);if(videoMatch){videoMatch.completed=savedVideo.completed;videoMatch.completionDate=savedVideo.completionDate;}});}if(savedTopic.quizzes&&Array.isArray(savedTopic.quizzes)){savedTopic.quizzes.forEach((savedQuiz,index)=>{const quizMatch=topic.quizzes.find(q=>q.quizId===savedQuiz.quizId)||(index<topic.quizzes.length?topic.quizzes[index]:null);if(quizMatch){quizMatch.completed=savedQuiz.completed;quizMatch.completionDate=savedQuiz.completionDate;}});}if(typeof savedTopic.completed==='boolean'){if(savedTopic.completed){topic.videos.forEach(video=>{video.completed=true;video.completionDate=video.completionDate||new Date().toISOString();});topic.quizzes.forEach(quiz=>{quiz.completed=true;quiz.completionDate=quiz.completionDate||new Date().toISOString();});}}}});}
        }
        
        // Document ready function (Keep as is, except maybe initial tab click)
        document.addEventListener('DOMContentLoaded', async function() {
            await identifyUser();
            await displayGlobalBookmarkIndicator(); 
            if (currentUserId) { await syncOfflineQueue(); }
            try { /* QR Code generation logic */ } catch(qrError) { /* ... */ }
            document.getElementById('grok-prompt').textContent = grokPrompt;
            document.querySelectorAll('.tab-button').forEach(button => { button.addEventListener('click', () => { /* Tab switching logic */ 
                document.querySelectorAll('.tab-button').forEach(btn=>{btn.classList.remove('active');});button.classList.add('active');const contentId=button.id.replace('tab-','content-');document.querySelectorAll('.tab-content').forEach(content=>{content.classList.remove('active');});document.getElementById(contentId).classList.add('active'); if(button.id==='tab-flowchart'){setTimeout(renderFlowchart,50);} if(button.id==='tab-study-materials'){loadTopicProgress();populateTopicCards();updateAllBookmarkButtons();} if(button.id==='tab-grok-prompt'){loadTopicProgress();updateCurrentTopicInfo();updateAllBookmarkButtons();populateQuickAccessTopics();updateAllBookmarkButtons();} if(button.id==='tab-overall-progress'){displayOverallProgress();} 
            }); });
            document.getElementById('copy-button').addEventListener('click', () => { /* Copy logic */ });
            document.getElementById('reset-progress-btn').addEventListener('click', resetProgress);
            
            // Keep initial check for active tab
            if (document.getElementById('tab-flowchart').classList.contains('active')) { renderFlowchart(); }
            if (document.getElementById('tab-study-materials').classList.contains('active')) { loadTopicProgress(); populateTopicCards(); updateAllBookmarkButtons(); }
            if (document.getElementById('tab-grok-prompt').classList.contains('active')) { loadTopicProgress(); updateCurrentTopicInfo(); updateAllBookmarkButtons(); populateQuickAccessTopics(); updateAllBookmarkButtons(); }
            if (document.getElementById('tab-overall-progress').classList.contains('active')) { displayOverallProgress(); }
            
            // Make a specific tab active by default (e.g., Study Materials)
            document.getElementById('tab-study-materials').click(); 
            
            // Initial load for the default active tab
            loadTopicProgress();
            populateTopicCards(); 
            updateAllBookmarkButtons(); 
            
            console.log('DOM fully loaded and parsed');
        });
        
        // Function to update current topic info in the Grok Prompt tab (Keep as is)
        function updateCurrentTopicInfo() { /* ... (Keep this function body as is) ... */ }
        
        // Function to populate quick access topic cards in the Grok Prompt tab (Keep as is)
        function populateQuickAccessTopics() { /* ... (Keep this function body as is) ... */ }
        
        // Function to set a topic as current (Keep as is)
        function setTopicAsCurrent(topicName) { /* ... (Keep this function body as is) ... */ }
        
        // Function to handle completion change for individual items (Keep as is)
        function handleItemCompletionChange(event) { /* ... (Keep this function body as is) ... */ }
        
        // Make the topic functions available globally (Keep as is)
        window.markTopicAsCompleted = markTopicAsCompleted;
        window.markVideoComplete = markVideoComplete;
        window.markQuizComplete = markQuizComplete;
        window.handleItemCompletionChange = handleItemCompletionChange;
        
        // Listen for browser coming back online (Keep as is)
        window.addEventListener('online', function() { /* ... (Keep this function body as is) ... */ });
        
        // Initialize overall progress tab if that tab is initially selected (Keep as is - though redundant now due to default click)
        if (document.getElementById('tab-overall-progress').classList.contains('active')) { displayOverallProgress(); }
        
        // Function to display overall progress information (Keep as is)
        async function displayOverallProgress() { /* ... (Keep this function body as is) ... */ }
        
        // Function to display total remaining item counts (Keep as is)
        function displayRemainingItemCounts() { /* ... (Keep this function body as is) ... */ }
        
        // Function to display flexible quota information based on AP exam deadline (Keep as is)
        async function displayFlexibleQuota() { /* ... (Keep this function body as is) ... */ }
        
        // Function to display a dot plot visualization of completions from Supabase (Keep as is)
        async function displaySupabaseDotPlot() { /* ... (Keep this function body as is) ... */ }
        
        // Function to display daily quota status from Supabase (Keep as is)
        async function displayDailyQuotaStatus() { /* ... (Keep this function body exactly as in the working version) ... */ 
            const container = document.getElementById('todays-quota-status'); console.log(`DEBUG (QuotaDisplay - Entry): Function called. currentUserId is: ${currentUserId} (Type: ${typeof currentUserId})`); if (!currentUserId) { container.innerHTML = `<div class="p-3 bg-gray-50 border border-gray-200 rounded-lg"><p class="text-gray-700">Enter username to see quota status.</p></div>`; return; } container.innerHTML = `<p class="text-gray-500">Loading today's goal status...</p>`; try { console.log('DEBUG (QuotaDisplay): Calculating dynamic quota targets...'); const { requiredVideosPerDay, requiredQuizzesPerDay, error: quotaError } = await calculateDynamicQuota(); if (quotaError) { console.error(`DEBUG (QuotaDisplay): Failed to calculate dynamic quota: ${quotaError}.`); container.innerHTML = `<div class="p-3 bg-red-50 border border-red-200 rounded-lg"><p class="text-red-700">Could not calculate dynamic goal: ${quotaError}. Please try again later.</p></div>`; return; } console.log(`DEBUG (QuotaDisplay): Dynamic targets: Videos=${requiredVideosPerDay}, Quizzes=${requiredQuizzesPerDay}`); let videosToday = 0; let quizzesToday = 0; const now = new Date(); const startOfDayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0, 0)); const endOfDayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23, 59, 59, 999)); try { const { data: completionsData, error: completionsError } = await supabaseClient .from('completions') .select('item_type') .eq('user_id', currentUserId) .gte('completed_at', startOfDayUTC.toISOString()) .lte('completed_at', endOfDayUTC.toISOString()); if (completionsError) { console.warn("DEBUG (QuotaDisplay): Error fetching today's completions for display:", completionsError.message); } else if (completionsData) { videosToday = completionsData.filter(i => i.item_type === 'video').length; quizzesToday = completionsData.filter(i => i.item_type === 'quiz').length; } console.log(`DEBUG (QuotaDisplay): Display using completions: ${videosToday} videos, ${quizzesToday} quizzes.`); } catch (fetchError) { console.error('DEBUG (QuotaDisplay): Exception fetching completions for display:', fetchError); } let isQuotaMetInDB = false; const todayDateString = startOfDayUTC.toISOString().split('T')[0]; let dbReadSucceeded = false; try { const { data: quotaStatusData, error: quotaStatusError } = await supabaseClient .from('daily_quotas_met') .select('id') .eq('user_id', currentUserId) .eq('quota_date', todayDateString) .maybeSingle(); if (quotaStatusError) { console.warn(`DEBUG (QuotaDisplay): Error fetching quota status from DB for display: ${quotaStatusError.message}`); } else { isQuotaMetInDB = (quotaStatusData !== null); dbReadSucceeded = true; } console.log(`DEBUG (QuotaDisplay): Quota met status from DB read: ${isQuotaMetInDB} (Read success: ${dbReadSucceeded})`); } catch (statusError) { console.error('DEBUG (QuotaDisplay): Exception fetching quota met status for display:', statusError); } const isBodyClassSet = document.body.classList.contains('quota-met-today'); let displayQuotaMet; if (dbReadSucceeded) { if (isQuotaMetInDB && !isBodyClassSet) { console.warn("DEBUG (QuotaDisplay): DB says MET, but body class NOT set. Using DB status (Met)."); displayQuotaMet = true; } else if (!isQuotaMetInDB && isBodyClassSet) { console.warn("DEBUG (QuotaDisplay): DB says NOT MET, but body class IS set. Using body class status (Met)."); displayQuotaMet = true; } else { displayQuotaMet = isQuotaMetInDB; } } else { console.warn("DEBUG (QuotaDisplay): DB read failed or inconsistent, relying on body class."); displayQuotaMet = isBodyClassSet; } console.log(`DEBUG (QuotaDisplay): Final determined display status: ${displayQuotaMet}`); let statusHtml = `<h3 class="text-lg font-semibold mb-3 text-indigo-800">Today's Dynamic Goal Progress</h3>`; const videoPercent = requiredVideosPerDay > 0 ? Math.min(100, (videosToday / requiredVideosPerDay) * 100) : (videosToday > 0 ? 100 : 0); statusHtml += `<div class="mb-4"><div class="flex justify-between mb-1"><span class="text-sm font-medium text-gray-700">Videos</span><span class="text-sm font-medium text-gray-700">${videosToday}/${requiredVideosPerDay}</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${videoPercent}%"></div></div></div>`; const quizPercent = requiredQuizzesPerDay > 0 ? Math.min(100, (quizzesToday / requiredQuizzesPerDay) * 100) : (quizzesToday > 0 ? 100 : 0); statusHtml += `<div class="mb-4"><div class="flex justify-between mb-1"><span class="text-sm font-medium text-gray-700">Quizzes</span><span class="text-sm font-medium text-gray-700">${quizzesToday}/${requiredQuizzesPerDay}</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-green-600 h-2.5 rounded-full" style="width: ${quizPercent}%"></div></div></div>`; if (displayQuotaMet) { statusHtml += `<div class="flex items-center p-3 bg-green-50 border border-green-200 rounded-lg mb-3"><svg class="w-6 h-6 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg><p class="font-medium text-green-700">Met! Well done!</p></div><p class="mt-2 text-sm text-gray-500">Your dynamic quota completion for today has been recorded.</p>`; } else { statusHtml += `<div class="flex items-center p-3 bg-yellow-50 border border-yellow-200 rounded-lg mb-3"><svg class="w-6 h-6 text-yellow-500 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg><p class="font-medium text-yellow-700">Not yet met. Keep going!</p></div><p class="mt-2 text-sm text-gray-500">Complete approximately ${requiredVideosPerDay} videos and ${requiredQuizzesPerDay} quizzes today to meet your dynamic goal.</p>`; } container.innerHTML = statusHtml; } catch (error) { console.error('Critical Error in displayDailyQuotaStatus:', error); container.innerHTML = `<div class="p-3 bg-red-50 border border-red-200 rounded-lg"><p class="text-red-700">Could not display quota status due to an error: ${error.message}</p></div>`; }
        }
        
        // Function to calculate the dynamic flexible daily quota (Keep as is)
        async function calculateDynamicQuota() { /* ... (Keep this function body as is) ... */ }
        
        // Function to fetch and display peer quota achievements (Keep as is)
        async function fetchAndDisplayPeerQuotas() { /* ... (Keep this function body as is) ... */ }

    </script>
    
    <!-- React Component (Keep as is) -->
    <script type="text/babel">
        const APStatLearningFlow = () => { /* ... (Keep this React component code exactly as is) ... */ };
        ReactDOM.render(<APStatLearningFlow />, document.getElementById('learning-flow-app'));
    </script>
    
    <!-- QR Code Section (Keep as is) -->
    <div class="my-4 flex flex-col items-center">
        <div id="qrcode-container" class="p-2 bg-white border border-gray-300 rounded-lg shadow-sm inline-block"></div>
        <p class="text-xs text-gray-500 mt-1">Scan for page link</p>
    </div>
    
</body>
</html>